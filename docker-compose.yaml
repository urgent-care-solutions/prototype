services:
  gateway:
    build:
      context: .
      dockerfile: ./gateway/Dockerfile
    restart: always
    container_name: api-gateway
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8000/healthz" ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    ports:
      - 8000:8000
    networks:
      - phi
    depends_on:
      - rbac
      - auth
      - audit

  rbac:
    build:
      context: .
      dockerfile: ./services/rbac_service/Dockerfile
    restart: always
    container_name: rbac-service
    command: >
      sh -c "touch /app/services/rbac_service/database/rbac.db &&
             uv run alembic upgrade head &&
             uv run faststream run src.main:app --host 0.0.0.0 --port 8080"
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8080/healthz" ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    networks:
      - phi
    depends_on:
      - nats
    volumes:
      - rbac_data:/app/services/rbac_service/database

  auth:
    build:
      context: .
      dockerfile: ./services/auth_service/Dockerfile
    restart: always
    container_name: auth-service
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8030/healthz" ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    ports:
      - 8030:8030
    networks:
      - phi
    depends_on:
      - rbac
      - nats

  audit:
    build:
      context: .
      dockerfile: ./services/audit_service/Dockerfile
    restart: always
    container_name: audit-service
    command: >
      sh -c "touch /app/services/audit_service/database/audit.db &&
             uv run alembic upgrade head &&
             uv run faststream run src.main:app --host 0.0.0.0 --port 8020"
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8020/healthz" ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    ports:
      - 8020:8020
    networks:
      - phi
    depends_on:
      - nats
    volumes:
      - audit_data:/app/services/audit_service/database

  patients:
    build:
      context: .
      dockerfile: ./services/patient_service/Dockerfile
    restart: always
    container_name: patients-service
    command: >
      sh -c "touch /app/services/patient_service/database/patients.db &&
             uv run alembic upgrade head &&
             uv run faststream run src.main:app --host 0.0.0.0 --port 8100"
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8100/healthz" ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    ports:
      - 8100:8100
    networks:
      - phi
    depends_on:
      - rbac
      - auth
      - nats
    volumes:
      - patients_data:/app/services/patient_service/database

  appointments:
    build:
      context: .
      dockerfile: ./services/appointments_service/Dockerfile
    restart: always
    container_name: appointments-service
    command: >
      sh -c "touch /app/services/appointments_service/database/appointments.db &&
             uv run alembic upgrade head &&
             uv run faststream run src.main:app --host 0.0.0.0 --port 8010"
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8010/healthz" ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    ports:
      - 8010:8010
    networks:
      - phi
    depends_on:
      - rbac
      - auth
      - nats
    volumes:
      - appointments_data:/app/services/appointments_service/database

  ehr:
    build:
      context: .
      dockerfile: ./services/ehr_service/Dockerfile
    restart: always
    container_name: ehr-service
    command: >
      sh -c "touch /app/services/ehr_service/database/ehr.db &&
             uv run alembic upgrade head &&
             uv run faststream run src.main:app --host 0.0.0.0 --port 8200"
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8200/healthz" ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    ports:
      - 8200:8200
    networks:
      - phi
    depends_on:
      - rbac
      - auth
      - nats
    volumes:
      - ehr_data:/app/services/ehr_service/database

  billing:
    build:
      context: .
      dockerfile: ./services/integration_service/Dockerfile
    restart: always
    container_name: integration-service
    command: >
      sh -c "touch /app/services/integration_service/database/integration.db &&
             uv run alembic upgrade head &&
             uv run faststream run src.main:app --host 0.0.0.0 --port 8300"
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8300/healthz" ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    ports:
      - 8300:8300
    networks:
      - phi
    depends_on:
      - rbac
      - auth
      - nats
    volumes:
      - billing_data:/app/services/integration_service/database

  notification:
    build:
      context: .
      dockerfile: ./services/notification_service/Dockerfile
    restart: always
    container_name: notification-service
    command: >
      sh -c "touch /app/services/notification_service/database/notification.db &&
             uv run alembic upgrade head &&
             uv run faststream run src.main:app --host 0.0.0.0 --port 8400"
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8400/healthz" ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    ports:
      - 8400:8400
    networks:
      - phi
    depends_on:
      - rbac
      - auth
      - nats
    volumes:
      - notification_data:/app/services/notification_service/database

  reporting:
    build:
      context: .
      dockerfile: ./services/reporting_service/Dockerfile
    restart: always
    container_name: reporting-service
    command: >
      sh -c "touch /app/services/reporting_service/database/reporting.db &&
             uv run alembic upgrade head &&
             uv run faststream run src.main:app --host 0.0.0.0 --port 8500"
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8500/healthz" ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    ports:
      - 8500:8500
    networks:
      - phi
    depends_on:
      - rbac
      - auth
      - nats
    volumes:
      - reporting_data:/app/services/reporting_service/database

  seeder:
    build:
      context: .
      dockerfile: ./seeder/Dockerfile
    container_name: data-seeder
    restart: no
    environment:
      - SEED_DATA=${SEED_DATA:-false}
    volumes:
      - rbac_data:/data/rbac
      - patients_data:/data/patients
      - appointments_data:/data/appointments
      - ehr_data:/data/ehr
      - billing_data:/data/billing
      - notification_data:/data/notification
      - reporting_data:/data/reporting
      - audit_data:/data/audit
    depends_on:
      rbac:
        condition: service_healthy
      patients:
        condition: service_healthy
      appointments:
        condition: service_healthy
      ehr:
        condition: service_healthy
      billing:
        condition: service_healthy
      reporting:
        condition: service_healthy
    networks:
      - phi

  nats:
    image: nats:2.12.2-alpine
    container_name: nats
    command:
      - --jetstream
      - --store-dir=/data
      - --max_memory_store=1G
      - --max_file_store=10G
    volumes:
      - nats_data:/data
    healthcheck:
      test: [ "CMD", "wget", "--spider", "http://localhost:8222/healthz" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    ports:
      - 4222:4222
      - 6222:6222
      - 8222:8222
    networks:
      - phi

  redis:
    image: redis:8.4.0-alpine3.22
    container_name: redis
    command:
      - --loglevel warning
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    ports:
      - 6379:6379
    networks:
      - phi

volumes:
  nats_data:
  ehr_data:
  appointments_data:
  patients_data:
  audit_data:
  billing_data:
  notification_data:
  reporting_data:
  rbac_data:


networks:
  phi:
    driver: bridge
